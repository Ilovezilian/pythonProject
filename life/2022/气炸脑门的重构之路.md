## 气炸脑门的重构之路
>  - Author: shuai.pan 潘帅
>  - Date:  2022-04-06

## 概述
清明节前夕，看老多人在朋友圈秀各种出游照片，本来是一个正常不过的事情了，毕竟在深圳大家都被折腾那么久了，好不容易有机会出门玩一下。
> 都可以理解。

可是我在加班。
> 那也可以理解

可是我在改bug，被之前乱糟糟的代码折磨的时候。
> 对不起，理解不了

所以准备螳臂当车、以卵击石地在朋友圈 **complain** 一下。

## 关于加班
### 加班候补名单
就在一个炎热难耐灰尘满天飞的下午，顶头上司过来挨个问要不要加班轮到我那一刻。
在紧锣密鼓修改代码的山人，终于反应过来。
联想到部门官方群10点中发了一条加班申请的消息，照上司这态度，这逼上梁山的概率就不小。
> 其实确定加班前几天本山人的事情不多，至少不需要到节假日来加班的程度。

太阳渐渐被云遮住，不知何处的风拔地而起起来了，尘土被带在地面上游龙戏凤。
避无可避逃无可逃，只能迎难而上了，本山人动之以情、晓之以理。
奈何顶头上司顶风作案，任我操作花里胡哨然一笑了之， 最后得到一个给登记到加班表中，如果确定不来再说的回复。
感觉至少还可以抢救一下自己的假期，和朋友约好爬梧桐山的计划还是有机会继续进行的。

### 检查环境功能
不知何时，那已经乌云层层迭起，被风吹起的尘土已经直扑二楼的窗户而来。
那个拖了快一个月的界面改造需求要到收尾阶段了，协助处理过几个小问题的山人总觉得哪哪都不对劲。
作为模块对接的开发总跑腿，放下不多的bug，连窗外没来得及瞧过一眼，直接切换了版本代码和版本的环境进行测试。
基础的功能：

- 显示功能
	- 表单查看界面没有问题；
	- 表单编辑界面没有问题；
	- 表单新增界面没有问题；
- 保存功能
	- 表单编辑界面没有问题；
	- 表单新增界面没有问题；
	- 工作流审批节点界面报错;
- 提交功能
	- 表单查看界面没有问题；
	- 表单编辑界面没有问题；
	- 表单新增界面没有问题；
	- 工作流审批节点界面报错;
- 提交生效功能
	- 表单查看界面没有问题；
	- 表单编辑界面没有问题；
	- 表单新增界面没有问题；
- 流程图查看功能
	- 表单查看界面没有问题；
- 审批意见查看功能
	- 表单查看界面没有问题；
- 切换组织清空人员信息、人员编码信息、部分分录详情字段信息功能
	- 表单新增界面有问题；
	- 表单编辑界面有问题；
- 表单中分录功能
	- 首行填充默认值功能
		- 表单新增界面有问题；
	- 表单新增、编辑界面都有问题的功能
		- 新增非首行填充上一行的部分值为默认值功能；
		- 日期修改的触发校验问题；
		- 日期修改的触发的显示问题；
		- 输入时间格式的问题，校验问题；
		- 选择原因的前置校验问题；
		- 。。。

### 检查代码
此时风已经平和下来，那不羁的灰尘也被伴随着小区的湿润的空气给渐渐压下。
此时的我心情微微有点沉重，如果有看风水的老道在的话，可以看到山人头上，开始齐聚薄薄黑色。
这么多功能检测都没有通过，逻辑复杂直冲云霄？改动举步维艰？
单据是我主要维护的，对这里里面的代码和对应的功能点相当了解，觉得只是ui改造，改动还是相对不难的，只有一些取值赋值的地方需要调整一下即可。
所以当时给了专业前端前后端的查寻、保存、提交、校验请求的方法以及对应参数实例，稍微做了讲解，就好了。
后来有几个支持都是格式请求参数的格式问题，数据赋值问题，以及因此引起的一些后端报出来的问题。
协助的时候，自己也是比较忙，快速解决完问题就处理自己的事情，没有对功能进行验证，以及代码进行检查。

看了前端小哥的代码改造记录，一次性看全部改造记录。
额，怎么说，套用一句话来说就是：”每个方法、变量、调用我都能看懂，但是组合起来就迷之代码了“
原谅我真没看懂那些逻辑的作用和ui修改有啥关联，加了那么多代码有啥作用。
原来的自定义的代码没作用，还在跑着，难道不用删了？
这是专业前端能干出来事，代码写成这样？
。。。

### 板上钉钉的加班
风吹打这树叶发出沙沙声响，那雨啪嗒啪嗒抽打在床上溅起小小的水花，然后汇合其它小花一起向下流去。
感觉十分不妙，虽然测试提的bug只有零星几个，但是看代码的结果这样的功能无论如何都无法交互给客户的。
看到那间歇花了一个月，期间还梅开二度的发版前撤回操作。
接下来只有一周的时间，如果只是那个小哥，那个和我抱怨多次改到疯掉的小哥改的话，`The problem impossible be solved`。

而且领导不会考虑再次延期，清明加班明显是一个解决这个问题的契机。

果然过去和上司回报陈述之后，结果没有任何意外。
爬山计划破产，加班板上钉钉。

## 开始加班
### 第一天
在群里那计划爬山郊游群热烈讨论怎么进行接下来的接头活动安排时，拖着沉重的步伐挪到那无比熟悉的大门前，走到山人工位开始了被加班生活。

#### 预期目标
综合之前的分析，结合跟领导那边争取出来8号之前的时间，开始给今天定一个目标。
- 调整之前保存、提交之前的数据聚合混乱，导致工作流提交时分录被无限自我套娃；
- 调整界面初始化的部分字段触发事件，避免毫无业务意义的操作就被触发并更新了数据；
- 抽取自定义的分录详情行操作（新增、删除）创建的单元格触发器，关联的单元格校验逻辑，单元格格式化器等逻辑到平台对应行操作中；
- 去掉自定义的界面生成渲染，新增行效果渲染、删除行效果渲染对应的代码，全部使用平台的统一封装；

#### 理论AC
- 解决提交后端数据结构混乱问题
对于相对了解代码结构的我来说，修复结构的报错还是相对简单，确定了结构以及输出的结构，只要理清结构，在合适地方改动调整即可。完全可以避免出现重复自套娃的情况。
不能截图代码，嘿嘿。描述一下自行脑补就好。

- 处理UI的界面操作
从用户使用UI来看：单据是面向不同的用户群体有不同的界面，和不同的查看和操作权限；除了一些权限相关字段显示操作，以及部分的特性功能之外，逻辑是相同的；
从代码层面来看（如图），逻辑相同之处代码也是相同的。不相同的部分就抽取出来调整即可。
![改造之前的代码结构](Pasted%20image%2020220406001003.png)

- 处理触发条件
平台表单提供了众多交互方法：行新增、行删除、行设置值、单元格获取、设置值等；
有琳琅满目的触发事件：balabala；
把所有自定义的功能对号入座调整过去就ok。

- 处理删除自定义的界面生成渲染，新增行效果渲染、删除行效果渲染
上面部分调整好之后，删掉就好了。

#### 实际上手
窗外的风又打了起来，雨声愈发侵入人耳。
从那小哥能改出无限自套娃惊为天人的bug开始，山人就再对那代码抱有丝毫的幻想。
可是看着看着，代码越看越不忍直视。直接改错，按照实际业务逻辑调整对应的代码，不需要的代码直接删掉，改完之后。也就花了2个小时的样子，顺带抽取方法、简化代码。

这不是挺简单的。
第一步完成，接着第二步。
调整代码就需要考虑全局的结构，上图很好表示业务结构和代码结构。其实这也表示一点，三个单据界面有很多重复代码，这些代码显然是无法同步到平台的，所以需要调整一下结构，如下图：
![改造之后的代码结构](Pasted%20image%2020220406004200.png)
所有相同的代码都抽取到父类，这样极大减少了代码重复率，同时更好的进行拓展。同时一个公共功能不用再做`cccv`工程师了

可是当看到那些被无数次吐槽还最终因为没有时间而导致强行忽视的前辈智慧结晶时。
- 一个时间表达式的校验需要在3个不同的方法里面写？
- 每时间校验逻辑还用不同的正则表达式去表示？
- 表达式变量`a` `b` `v` ，有啥意义，生怕别人看得懂？
- 写个注释表示时校验时间是24小时制的，有啥用？
- 。。 。
血压是在蹭蹭往上涨，压都压不住。伴随着血压的是本人自以为的无声的怒吼，然后发现旁边小哥哥，对面小姐姐全听到了，毕竟同桌都给反馈了。QAQ
删掉所有校验，然后加了俩行代码到编辑行之后保存方法进行校验时间格式即可。
时间格式校验的方法平台提供了工具，问了一下平台的同事搞定。
多看看平台提供了那些功，直接用就好了，需要写那么多代码来造轮子？用来堆工作量？
境界不一样本山人属实理解不了。

接下来处理日期、等其他字段逻辑。随之而来的血压一直在飙升，从未被间断。
- 平台有组件，偏偏使用最朴素的jQuery语法来取值、赋值，上辈子和组件有仇？
- 面向对象编程，用字符串拼接，拼接再解析，再处理，直接处理对象简单点不行？
- 方法传参有多少加多少，js做一个对象不是秒秒钟的事情？
- 一个新增行，2x2`if-else`来表示写新增行？嫌弃新增方法简单，要加点难度？
- 创建一个成员变量存日期，就是为了后面首行日期赋值一次，成员变量高级所以用？

代码和混乱的逻辑时，当时就想抽出40米的大砍刀一挥而下。
此时接受学校16年素质教育，和多年优良家庭教育山人不由得心一慌，小脑袋瓜子瞬间冷静下来，那挥刀的手不由一收，
这么容易就被愤怒冲昏了头脑？绝对不行，越是这种时候，就越需要冷静。
不然对不起所受教育栽培，所以先让那人先跑39米再倾力一挥。
如图
![](Pasted%20image%2020220404225030.png)
体现了足够冷静，良好的视力，不忘初心的结果。
一举多得。

别妄想本山人放过，写那么挫的代码，还好意思活着？ 


### 第二天
终于还是挨到第二天，只是昨天回的比较晚。
如果有人奇怪加班怎么可以那么晚回？那肯定不是bug太多改不过来，而是代码太烂，不在一定范围内改完，完全没有回去的心思。

#### 预期目标
- 处理遗留的数据关联清空并带出问题；
- 解决员工单据的特性功能，并且不影响到二次开发人员的代码；
- 将部分初始化功能从前端迁移到更合适的后端；
- 删除多余无用代码；
- 把单据类的重复代码搬移到父类中去，减少重复代码；
### 实际上手
经过昨天的捶打，今天心态总算好多了。
一方面，大部分的关键逻辑和代码昨天都搞定了，今天要做的事情就是收尾以及重构代码了； 另一方面，今天心也比昨天强大，毕竟错误都已经司空见惯，见怪不怪。
不过今天是一个细致活，还需要不断调整、验证。

不过人生处处是惊喜。
- 初始化的开始还好好的，怎么后面就突然删掉了？删的逻辑和我玩了半天的躲猫猫QAQ
- 为什么组织字段初始化之后会触发本应该手动更改才触发清空指定字段值QAQ
- 为什么本地环境就是死也起不来，移情别恋了？QAQ

越是到了此时才越发觉得程序设计模式对程序设计的重要性，代码重构对于调整结构的指导作用。

今天也晚回了，回到都9点了。闲杂回想起来都不知道为什么会导致那么耗时。
有一个小插曲，因为加班这两天都没有赶上核酸，今天转了几个监测点都关了。差点以为一个小区的入口快递摊是检测口，傻傻跑过去。诶
想想48小时核酸，明天没办法到公司上班，于是准备好措辞，准备好远程办公（请假是不可能请假成功的） 。


## 总结
- 可以脑力解决的问题，坚决避免要用体力解决；
	- 多看看结构，多思考几种解决方案，从中找到更合适、更优的解。而不是闷头就干，直接堆功能，累代码；
- 一个请求可以搞定的事情，避免添加n个请求来完成；
	- 每个请求都需要走网络的，都要耗时，虽然一般来说感觉不明显。但是放在一次请求更合理、也更加高效直接合并就好；
- 需求一直在变，系统也一直在变，系统结构调整来适应；
	- 字符串拼接结构，不是“一招鲜，吃遍天”，也不是放之四海而皆准的“金手指”；面向对象是不错的方式，设计模式也是，代码重构了解一下。

代码重构里面定义挺有意思
![[refacting#^7d2a11]]

代码是统动态调整内部逻辑来不断提升系统性能的过程。

真是被气的，本山人有时间多学习一下《程序员的自我修养》《代码重构》《设计模式》。

--- 致一次气炸脑门代码重构之路
